{% extends "base.html" %}
{% block content %}

<style>
  :root{
    --text:#0f172a;
    --muted:#475569;
    --border:rgba(15,23,42,.10);

    --primary:#2f6fed;
    --primary-2:#1d4ed8;
    --accent:#7c3aed;

    --danger:#ef4444;
    --success:#10b981;

    --shadow:0 18px 50px rgba(2,6,23,.12);
    --shadow-soft:0 12px 30px rgba(2,6,23,.08);

    --radius-xl:26px;
    --radius-lg:18px;
    --radius-md:14px;

    --ease:cubic-bezier(.2,.8,.2,1);
  }

  .rep-wrap{ display:grid; gap: 14px; }

  .head{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:16px;
  }
  .title{
    margin:0;
    font-size: 22px;
    letter-spacing:-.02em;
    color:var(--text);
    font-weight: 1000;
  }
  .sub{
    margin:6px 0 0;
    color:var(--muted);
    font-weight:700;
    font-size: 13.5px;
    line-height: 1.5;
  }

  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding: 8px 10px;
    border-radius: 999px;
    background: rgba(47,111,237,.10);
    border: 1px solid rgba(47,111,237,.18);
    color: #1e3a8a;
    font-weight: 1000;
    font-size: 12px;
    white-space:nowrap;
  }

  /* Filter card */
  .card{
    background: rgba(255,255,255,.88);
    border: 1px solid var(--border);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow);
    overflow:hidden;
    transform: translateY(10px);
    opacity: 0;
    transition: transform .9s var(--ease), opacity .9s var(--ease);
  }
  .card.is-in{ transform:none; opacity:1; }

  .card-head{
    padding: 18px 18px 14px;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap: 12px;
    border-bottom: 1px solid rgba(15,23,42,.08);
    background:
      radial-gradient(700px 240px at 10% 0%, rgba(47,111,237,.14), transparent 60%),
      radial-gradient(700px 240px at 100% 0%, rgba(124,58,237,.12), transparent 60%),
      rgba(255,255,255,.75);
    backdrop-filter: blur(10px);
  }

  .card-body{ padding: 18px; }

  .grid{
    display:grid;
    grid-template-columns: repeat(12, minmax(0, 1fr));
    gap: 12px;
  }

  .field{
    background: rgba(255,255,255,.92);
    border: 1px solid var(--border);
    border-radius: 18px;
    padding: 12px;
    box-shadow: 0 12px 26px rgba(2,6,23,.06);
  }
  .field .lbl{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    color: var(--muted);
    font-weight: 900;
    font-size: 12px;
    letter-spacing:.02em;
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  input[type="date"], select{
    width:100%;
    border-radius: 14px;
    border: 1px solid rgba(15,23,42,.10);
    padding: 11px 12px;
    background: rgba(255,255,255,.95);
    color: var(--text);
    font-weight: 800;
    font-size: 14px;
    outline:none;
    transition: box-shadow .25s var(--ease), border-color .25s var(--ease), transform .25s var(--ease);
  }
  input[type="date"]:focus, select:focus{
    border-color: rgba(47,111,237,.35);
    box-shadow: 0 0 0 6px rgba(47,111,237,.10);
    transform: translateY(-1px);
  }

  .actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:flex-end;
    margin-top: 12px;
    padding-top: 14px;
    border-top: 1px solid rgba(15,23,42,.08);
  }

  .btn{
    display:inline-flex;
    align-items:center;
    gap:10px;
    padding: 11px 14px;
    border-radius: 14px;
    border:1px solid var(--border);
    background: rgba(255,255,255,.92);
    color: var(--text);
    font-weight: 900;
    text-decoration:none;
    box-shadow: 0 12px 26px rgba(2,6,23,.08);
    transition: transform .25s var(--ease), box-shadow .25s var(--ease), border-color .25s var(--ease);
    cursor:pointer;
    user-select:none;
  }
  .btn:hover{
    transform: translateY(-2px);
    box-shadow: 0 18px 40px rgba(2,6,23,.12);
    border-color: rgba(47,111,237,.25);
  }
  .btn:active{ transform: translateY(0) scale(.99); }

  .btn.primary{
    background: linear-gradient(180deg, var(--primary), var(--primary-2));
    border-color: rgba(255,255,255,.35);
    color:#fff;
  }

  .btn .ic{ width:18px;height:18px; display:inline-flex; align-items:center; justify-content:center; }

  /* KPI cards */
  .kpis{
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 12px;
  }
  @media (max-width: 980px){
    .kpis{ grid-template-columns: 1fr; }
  }

  .kpi{
    background: rgba(255,255,255,.88);
    border: 1px solid var(--border);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-soft);
    padding: 16px;
    position:relative;
    overflow:hidden;
    transform: translateY(10px);
    opacity: 0;
    transition: transform .9s var(--ease), opacity .9s var(--ease);
  }
  .kpi.is-in{ transform:none; opacity:1; }

  .kpi::before{
    content:"";
    position:absolute;
    inset:-2px;
    background:
      radial-gradient(320px 140px at 0% 0%, rgba(47,111,237,.18), transparent 60%),
      radial-gradient(320px 140px at 100% 0%, rgba(124,58,237,.14), transparent 60%);
    opacity:.65;
    pointer-events:none;
  }

  .kpi .lbl{
    position:relative;
    color: var(--muted);
    font-weight: 900;
    font-size: 12px;
    letter-spacing:.02em;
    text-transform: uppercase;
  }
  .kpi .val{
    position:relative;
    margin-top: 8px;
    font-size: 26px;
    font-weight: 1000;
    letter-spacing:-.03em;
    color: var(--text);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .kpi .meta{
    position:relative;
    margin-top: 8px;
    color: var(--muted);
    font-weight: 750;
    line-height:1.5;
    font-size: 13px;
  }

  .tag{
    position:relative;
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding: 7px 10px;
    border-radius: 999px;
    font-weight: 1000;
    font-size: 12px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,.92);
    width: fit-content;
    margin-top: 10px;
  }
  .tag.good{ background: rgba(16,185,129,.10); border-color: rgba(16,185,129,.18); color:#065f46; }
  .tag.bad{ background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.18); color:#7f1d1d; }
  .tag.mid{ background: rgba(47,111,237,.10); border-color: rgba(47,111,237,.18); color:#1e3a8a; }

  /* Sales list section */
  .section{
    background: rgba(255,255,255,.88);
    border: 1px solid var(--border);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-soft);
    padding: 16px;
    transform: translateY(10px);
    opacity: 0;
    transition: transform .9s var(--ease), opacity .9s var(--ease);
  }
  .section.is-in{ transform:none; opacity:1; }

  .sec-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
    margin-bottom: 12px;
  }
  .sec-title{
    margin:0;
    font-size: 16px;
    font-weight: 1000;
    letter-spacing:-.01em;
    color: var(--text);
  }

  .search{
    flex:1;
    min-width: 240px;
    display:flex;
    align-items:center;
    gap:10px;
    padding: 10px 12px;
    border-radius: 16px;
    background: rgba(255,255,255,.92);
    border: 1px solid var(--border);
    box-shadow: 0 12px 26px rgba(2,6,23,.06);
  }
  .search input{
    width:100%;
    border:0;
    outline:none;
    font-size: 14px;
    font-weight: 800;
    color: var(--text);
    background: transparent;
  }

  .list{ display:grid; gap: 10px; margin-top: 10px; }

  .row{
    position:relative;
    display:grid;
    grid-template-columns: 1fr 1.2fr 1.4fr .9fr;
    gap: 10px;
    align-items:center;
    padding: 12px;
    border-radius: 18px;
    background: rgba(255,255,255,.92);
    border: 1px solid rgba(15,23,42,.10);
    box-shadow: 0 12px 24px rgba(2,6,23,.06);
    overflow:hidden;
    transition: transform .25s var(--ease), box-shadow .25s var(--ease);
  }
  .row:hover{
    transform: translateY(-2px);
    box-shadow: 0 18px 36px rgba(2,6,23,.10);
  }

  .cell{
    min-width:0;
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .cell .lbl{
    color: var(--muted);
    font-weight: 900;
    font-size: 11px;
    letter-spacing:.02em;
    text-transform: uppercase;
  }
  .cell .val{
    font-weight: 950;
    color: var(--text);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .profitWrap{
    display:flex;
    flex-direction:column;
    gap:8px;
    align-items:flex-start;
  }
  .bar{
    width: 100%;
    height: 8px;
    border-radius: 999px;
    background: rgba(15,23,42,.08);
    overflow:hidden;
    border: 1px solid rgba(15,23,42,.08);
  }
  .bar > span{
    display:block;
    height: 100%;
    width: 0%;
    border-radius: 999px;
    background: linear-gradient(90deg, var(--primary), var(--accent));
    transition: width .7s var(--ease);
  }

  .empty{
    text-align:center;
    padding: 18px;
    border-radius: 18px;
    background: rgba(255,255,255,.92);
    border: 1px solid rgba(15,23,42,.10);
    color: var(--muted);
    font-weight: 850;
    box-shadow: 0 12px 26px rgba(2,6,23,.06);
  }

  @media (max-width: 980px){
    .row{
      grid-template-columns: 1fr 1fr;
      grid-template-areas:
        "date emp"
        "car profit";
    }
    .date{ grid-area: date; }
    .emp{ grid-area: emp; }
    .car{ grid-area: car; }
    .profit{ grid-area: profit; }
  }
  @media (max-width: 560px){
    .row{
      grid-template-columns: 1fr;
      grid-template-areas:
        "date"
        "emp"
        "car"
        "profit";
    }
  }

  @media (prefers-reduced-motion: reduce){
    .card,.kpi,.section{ transition:none!important; transform:none!important; opacity:1!important; }
    .bar > span{ transition:none!important; }
    input:focus, select:focus{ transform:none!important; }
  }
</style>

<div class="rep-wrap">

  <div class="head">
    <div>
      <h2 class="title">Reports</h2>
      <p class="sub">Filter sales by date range and employee. Export results to CSV for external analysis.</p>
    </div>
    <span class="pill" id="activeFilters">No active filters</span>
  </div>

  <!-- FILTERS -->
  <section class="card" id="filterCard">
    <div class="card-head">
      <div>
        <div class="title" style="font-size:18px;">Filters</div>
        <div class="sub" style="margin-top:6px;">Choose an exact date or a period, optionally filter by employee.</div>
      </div>
      <span class="pill" style="background: rgba(124,58,237,.10); border-color: rgba(124,58,237,.18); color:#4c1d95;">
        <span aria-hidden="true">üìå</span> Report controls
      </span>
    </div>

    <div class="card-body">
      <form method="get" id="reportForm">
        <div class="grid">
          <div class="field" style="grid-column: span 4;">
            <div class="lbl">
              <span>Exact date</span>
              <span style="opacity:.85;">optional</span>
            </div>
            <input type="date" name="date" value="{{ request.GET.date }}">
          </div>

          <div class="field" style="grid-column: span 4;">
            <div class="lbl">
              <span>Period start</span>
              <span style="opacity:.85;">optional</span>
            </div>
            <input type="date" name="start" value="{{ request.GET.start }}">
          </div>

          <div class="field" style="grid-column: span 4;">
            <div class="lbl">
              <span>Period end</span>
              <span style="opacity:.85;">optional</span>
            </div>
            <input type="date" name="end" value="{{ request.GET.end }}">
          </div>

          <div class="field" style="grid-column: span 12;">
            <div class="lbl">
              <span>Employee</span>
              <span style="opacity:.85;">optional</span>
            </div>
            <select name="employee_id" id="employeeSelect">
              <option value="">-- all --</option>
              {% for e in employees %}
                <option value="{{ e.id }}" {% if request.GET.employee_id == e.id|stringformat:"s" %}selected{% endif %}>
                  {{ e.full_name }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="actions">
          <button type="submit" class="btn primary">
            <span class="ic" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 21l-4.3-4.3"></path>
                <circle cx="11" cy="11" r="7"></circle>
              </svg>
            </span>
            Filter
          </button>

          <button type="submit" name="export" value="csv" class="btn">
            <span class="ic" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 3v6h6"></path>
                <path d="M5 12v9a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V9l-6-6H7a2 2 0 0 0-2 2v3"></path>
                <path d="M8 13h8"></path>
                <path d="M8 17h8"></path>
              </svg>
            </span>
            Download CSV
          </button>

          <button type="button" class="btn" id="clearBtn">
            <span class="ic" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18"></path>
                <path d="M8 6V4h8v2"></path>
                <path d="M10 11v6"></path>
                <path d="M14 11v6"></path>
              </svg>
            </span>
            Clear
          </button>

          <span class="pill" style="margin-left:auto; background: rgba(16,185,129,.10); border-color: rgba(16,185,129,.18); color:#065f46;">
            <span aria-hidden="true">‚¨áÔ∏è</span> CSV export ready
          </span>
        </div>
      </form>
    </div>
  </section>

  <!-- KPIs -->
  <section class="kpis" aria-label="Key metrics">
    <div class="kpi" id="kpi1">
      <div class="lbl">Total profit</div>
      <div class="val" id="totalProfitVal">{{ total_profit }}</div>
      <div class="meta">Overall profit based on selected filters.</div>
      <span class="tag mid" id="profitTag">Calculating‚Ä¶</span>
    </div>

    <div class="kpi" id="kpi2">
      <div class="lbl">Best-selling car</div>
      <div class="val">{{ best_car|default:"-" }}</div>
      <div class="meta">Most frequently sold vehicle in this report.</div>
      <span class="tag mid" id="bestTag">Based on results</span>
    </div>

    <div class="kpi" id="kpi3">
      <div class="lbl">Top salesperson</div>
      <div class="val">
        {% if top_emp %} {{ top_emp.0 }} {% else %}-{% endif %}
      </div>
      <div class="meta">
        {% if top_emp %} {{ top_emp.1 }} sales in the selected period. {% else %} No data available. {% endif %}
      </div>
      <span class="tag mid" id="topTag">
        {% if top_emp %} Leader {% else %} ‚Äî {% endif %}
      </span>
    </div>
  </section>

  <!-- SALES LIST -->
  <section class="section" id="salesSection">
    <div class="sec-head">
      <h3 class="sec-title">Sales list</h3>
      <div class="search">
        <span aria-hidden="true">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="7"></circle>
            <path d="M21 21l-4.3-4.3"></path>
          </svg>
        </span>
        <input id="saleSearch" type="text" placeholder="Search sales by date, employee, car, or profit...">
      </div>
      <span class="pill" id="salesCount">‚Äî items</span>
    </div>

    <div class="list" id="salesList">
      {% for s in sales %}
        <div class="row" data-row data-search="{{ s.sale_date }} {{ s.employee.full_name }} {{ s.car }} {{ s.profit }}">
          <div class="cell date">
            <div class="lbl">Date</div>
            <div class="val">{{ s.sale_date }}</div>
          </div>

          <div class="cell emp">
            <div class="lbl">Employee</div>
            <div class="val">{{ s.employee.full_name }}</div>
          </div>

          <div class="cell car">
            <div class="lbl">Car</div>
            <div class="val">{{ s.car }}</div>
          </div>

          <div class="cell profit">
            <div class="lbl">Profit</div>
            <div class="profitWrap">
              <div class="val" data-profit>{{ s.profit }}</div>
              <div class="bar" aria-hidden="true"><span data-bar></span></div>
              <span class="tag mid" data-tag>‚Äî</span>
            </div>
          </div>
        </div>
      {% empty %}
        <div class="empty">No sales for selected filters.</div>
      {% endfor %}
    </div>

    <div class="empty" id="noMatch" style="display:none; margin-top: 12px;">
      No results match your search.
    </div>
  </section>

</div>

<script>
(function(){
  const filterCard = document.getElementById('filterCard');
  const kpi1 = document.getElementById('kpi1');
  const kpi2 = document.getElementById('kpi2');
  const kpi3 = document.getElementById('kpi3');
  const salesSection = document.getElementById('salesSection');

  // Reveal animations
  requestAnimationFrame(()=>{
    filterCard.classList.add('is-in');
    setTimeout(()=> kpi1.classList.add('is-in'), 60);
    setTimeout(()=> kpi2.classList.add('is-in'), 120);
    setTimeout(()=> kpi3.classList.add('is-in'), 180);
    setTimeout(()=> salesSection.classList.add('is-in'), 240);
  });

  // Clear filters (client-side)
  const clearBtn = document.getElementById('clearBtn');
  const reportForm = document.getElementById('reportForm');
  clearBtn?.addEventListener('click', ()=>{
    const url = new URL(window.location.href);
    url.search = '';
    window.location.href = url.toString();
  });

  // Active filters badge
  const activeBadge = document.getElementById('activeFilters');
  const params = new URLSearchParams(window.location.search);
  const keys = ['date','start','end','employee_id'];
  const active = keys.filter(k => (params.get(k)||'').trim() !== '');
  if(active.length === 0){
    activeBadge.textContent = 'No active filters';
  } else {
    activeBadge.textContent = `Active filters: ${active.length}`;
  }

  // KPI profit tag
  function parseNumber(v){
    if(v == null) return 0;
    const s = String(v).replace(/[^0-9.,-]/g,'').replace(/,/g,'');
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : 0;
  }
  const totalProfitEl = document.getElementById('totalProfitVal');
  const profitTag = document.getElementById('profitTag');
  const totalProfit = parseNumber(totalProfitEl ? totalProfitEl.textContent : 0);
  profitTag.classList.remove('good','mid','bad');
  if(totalProfit > 0){
    profitTag.classList.add('good');
    profitTag.textContent = 'Positive';
  } else if(totalProfit === 0){
    profitTag.classList.add('mid');
    profitTag.textContent = 'Break-even';
  } else {
    profitTag.classList.add('bad');
    profitTag.textContent = 'Negative';
  }

  // Sales list: count + search + profit bars
  const rows = Array.from(document.querySelectorAll('[data-row]'));
  const countEl = document.getElementById('salesCount');
  const input = document.getElementById('saleSearch');
  const noMatch = document.getElementById('noMatch');

  countEl.textContent = `${rows.length} items`;

  // Determine max absolute profit for bars
  const profits = rows.map(r => parseNumber(r.querySelector('[data-profit]')?.textContent || 0));
  const maxAbs = Math.max(1, ...profits.map(p => Math.abs(p)));

  rows.forEach((r, i)=>{
    const p = parseNumber(r.querySelector('[data-profit]')?.textContent || 0);
    const bar = r.querySelector('[data-bar]');
    const tag = r.querySelector('[data-tag]');

    // Bar width (0..100) based on abs profit
    const pct = Math.min(100, Math.round((Math.abs(p) / maxAbs) * 100));
    if(bar) setTimeout(()=> bar.style.width = pct + '%', 120 + i*25);

    if(tag){
      tag.classList.remove('good','mid','bad');
      if(p > 0){
        tag.classList.add('good');
        tag.textContent = 'Positive';
      } else if (p === 0){
        tag.classList.add('mid');
        tag.textContent = 'Break-even';
      } else {
        tag.classList.add('bad');
        tag.textContent = 'Negative';
      }
    }
  });

  function applyFilter(){
    const q = (input?.value || '').trim().toLowerCase();
    let visible = 0;

    rows.forEach(r=>{
      const hay = (r.getAttribute('data-search') || '').toLowerCase();
      const ok = !q || hay.includes(q);
      r.style.display = ok ? '' : 'none';
      if(ok) visible++;
    });

    countEl.textContent = `${visible} items`;
    noMatch.style.display = (rows.length > 0 && visible === 0) ? '' : 'none';
  }
  input?.addEventListener('input', applyFilter);

})();
</script>

{% endblock %}
