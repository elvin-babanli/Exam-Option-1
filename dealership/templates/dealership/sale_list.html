{% extends "base.html" %}
{% block content %}

<style>
  :root{
    --text:#0f172a;
    --muted:#475569;
    --border:rgba(15,23,42,.10);

    --primary:#2f6fed;
    --primary-2:#1d4ed8;
    --accent:#7c3aed;

    --danger:#ef4444;
    --success:#10b981;

    --shadow:0 18px 50px rgba(2,6,23,.12);
    --shadow-soft:0 12px 30px rgba(2,6,23,.08);

    --radius-xl:26px;
    --radius-lg:18px;
    --radius-md:14px;

    --ease:cubic-bezier(.2,.8,.2,1);
  }

  .sales-wrap{ position:relative; }

  .head{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:16px;
    margin-bottom: 14px;
  }

  .title{
    margin:0;
    font-size: 22px;
    letter-spacing:-.02em;
    color:var(--text);
    font-weight: 1000;
  }
  .sub{
    margin:6px 0 0;
    color:var(--muted);
    font-weight:700;
    font-size: 13.5px;
    line-height: 1.5;
  }

  .actions-top{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:flex-end;
  }

  .btn{
    display:inline-flex;
    align-items:center;
    gap:10px;
    padding: 11px 14px;
    border-radius: 14px;
    border:1px solid var(--border);
    background: rgba(255,255,255,.92);
    color: var(--text);
    font-weight: 900;
    text-decoration:none;
    box-shadow: 0 12px 26px rgba(2,6,23,.08);
    transition: transform .25s var(--ease), box-shadow .25s var(--ease), border-color .25s var(--ease);
    user-select:none;
  }
  .btn:hover{
    transform: translateY(-2px);
    box-shadow: 0 18px 40px rgba(2,6,23,.12);
    border-color: rgba(47,111,237,.25);
  }
  .btn:active{ transform: translateY(0) scale(.99); }

  .btn.primary{
    background: linear-gradient(180deg, var(--primary), var(--primary-2));
    border-color: rgba(255,255,255,.35);
    color:#fff;
  }

  .btn .ic{ width:18px;height:18px; display:inline-flex; align-items:center; justify-content:center; }

  .chip{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding: 8px 10px;
    border-radius: 999px;
    background: rgba(47,111,237,.10);
    border: 1px solid rgba(47,111,237,.18);
    color: #1e3a8a;
    font-weight: 1000;
    font-size: 12px;
    white-space:nowrap;
  }

  .toolbar{
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
    padding: 12px;
    border-radius: 18px;
    background: rgba(255,255,255,.75);
    border: 1px solid var(--border);
    box-shadow: 0 12px 26px rgba(2,6,23,.06);
    margin-bottom: 14px;
  }

  .search{
    flex:1;
    min-width: 240px;
    display:flex;
    align-items:center;
    gap:10px;
    padding: 10px 12px;
    border-radius: 16px;
    background: rgba(255,255,255,.92);
    border: 1px solid var(--border);
  }
  .search input{
    width:100%;
    border:0;
    outline:none;
    font-size: 14px;
    font-weight: 800;
    color: var(--text);
    background: transparent;
  }
  .search .hint{
    color: var(--muted);
    font-weight: 750;
    font-size: 12px;
    white-space: nowrap;
    opacity:.85;
  }

  .meta{
    display:flex;
    align-items:center;
    gap:10px;
    color: var(--muted);
    font-weight: 850;
    font-size: 12.5px;
    padding: 10px 12px;
    border-radius: 16px;
    background: rgba(255,255,255,.86);
    border: 1px solid var(--border);
  }
  .meta strong{ color: var(--text); }

  .list{ display:grid; gap: 12px; }

  .row{
    position:relative;
    display:grid;
    grid-template-columns: 1fr 1fr 1.2fr .9fr auto;
    gap: 12px;
    align-items:center;
    padding: 14px;
    border-radius: 18px;
    background: rgba(255,255,255,.88);
    border: 1px solid var(--border);
    box-shadow: 0 14px 28px rgba(2,6,23,.07);
    overflow:hidden;
    transform: translateY(10px);
    opacity: 0;
    transition: transform .8s var(--ease), opacity .8s var(--ease), box-shadow .25s var(--ease);
  }
  .row.is-in{ transform:none; opacity:1; }
  .row:hover{ box-shadow: 0 22px 44px rgba(2,6,23,.12); }

  .row::before{
    content:"";
    position:absolute;
    inset:-2px;
    background:
      radial-gradient(320px 120px at 0% 0%, rgba(47,111,237,.18), transparent 60%),
      radial-gradient(320px 120px at 100% 0%, rgba(124,58,237,.14), transparent 60%);
    opacity: 0;
    transition: opacity .35s var(--ease);
    pointer-events:none;
  }
  .row:hover::before{ opacity: 1; }

  .cell{
    display:flex;
    flex-direction:column;
    gap:6px;
    min-width:0;
  }
  .lbl{
    color: var(--muted);
    font-weight: 900;
    font-size: 11.5px;
    letter-spacing:.02em;
    text-transform: uppercase;
  }
  .val{
    font-weight: 1000;
    color: var(--text);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .tag{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding: 7px 10px;
    border-radius: 999px;
    font-weight: 1000;
    font-size: 12px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,.92);
    width: fit-content;
    max-width: 100%;
  }
  .tag.good{
    background: rgba(16,185,129,.10);
    border-color: rgba(16,185,129,.18);
    color: #065f46;
  }
  .tag.bad{
    background: rgba(239,68,68,.10);
    border-color: rgba(239,68,68,.18);
    color: #7f1d1d;
  }
  .tag.mid{
    background: rgba(47,111,237,.10);
    border-color: rgba(47,111,237,.18);
    color: #1e3a8a;
  }

  .row-actions{
    display:flex;
    justify-content:flex-end;
    gap:8px;
    flex-wrap:wrap;
  }
  .a{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding: 9px 12px;
    border-radius: 14px;
    text-decoration:none;
    font-weight: 950;
    font-size: 13px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,.92);
    color: var(--text);
    transition: transform .25s var(--ease), box-shadow .25s var(--ease), border-color .25s var(--ease);
    box-shadow: 0 12px 22px rgba(2,6,23,.06);
  }
  .a:hover{
    transform: translateY(-2px);
    box-shadow: 0 18px 36px rgba(2,6,23,.10);
    border-color: rgba(47,111,237,.25);
  }
  .a.danger{
    color:#7f1d1d;
    background: rgba(239,68,68,.10);
    border-color: rgba(239,68,68,.18);
  }
  .a .ic{ width:16px;height:16px; display:inline-flex; align-items:center; justify-content:center; }

  .empty{
    text-align:center;
    padding: 28px 16px;
    border-radius: 20px;
    background: rgba(255,255,255,.75);
    border: 1px solid var(--border);
    color: var(--muted);
    font-weight: 850;
    box-shadow: 0 12px 26px rgba(2,6,23,.06);
  }

  @media (max-width: 1100px){
    .row{
      grid-template-columns: 1fr 1fr;
      grid-template-areas:
        "date actions"
        "employee car"
        "price profit";
    }
    .date{ grid-area: date; }
    .employee{ grid-area: employee; }
    .car{ grid-area: car; }
    .price{ grid-area: price; }
    .profit{ grid-area: profit; }
    .row-actions{ grid-area: actions; justify-content:flex-end; }
  }
  @media (max-width: 560px){
    .row{
      grid-template-columns: 1fr;
      grid-template-areas:
        "date"
        "employee"
        "car"
        "price"
        "profit"
        "actions";
    }
    .row-actions{ justify-content:flex-start; }
  }

  @media (prefers-reduced-motion: reduce){
    .row{ transition:none!important; transform:none!important; opacity:1!important; }
  }
</style>

<div class="sales-wrap">
  <div class="head">
    <div>
      <h2 class="title">Sales</h2>
      <p class="sub">Register sales, track actual prices, and see profit per transaction.</p>
    </div>

    <div class="actions-top">
      <a class="btn primary" href="{% url 'dealership:sale_add' %}">
        <span class="ic" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14"></path>
            <path d="M5 12h14"></path>
          </svg>
        </span>
        Add sale
      </a>

      <a class="btn" href="{% url 'dealership:reports' %}">
        <span class="ic" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 3v18h18"></path>
            <path d="M7 14v4"></path>
            <path d="M11 10v8"></path>
            <path d="M15 7v11"></path>
          </svg>
        </span>
        Reports
      </a>

      <span class="chip" id="saleCount">â€” sales</span>
    </div>
  </div>

  <div class="toolbar">
    <div class="search">
      <span aria-hidden="true">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="7"></circle>
          <path d="M21 21l-4.3-4.3"></path>
        </svg>
      </span>
      <input id="saleSearch" type="text" placeholder="Search by date, employee, car, or price..." autocomplete="off">
      <span class="hint" id="searchHint">Ctrl / âŒ˜ + K</span>
    </div>

    <div class="meta">
      <span aria-hidden="true">ðŸ’¡</span>
      Profit tag updates automatically: <strong>Positive</strong>, <strong>Break-even</strong>, <strong>Negative</strong>.
    </div>
  </div>

  <div class="list" id="saleList">
    {% for s in object_list %}
      <div class="row" data-row data-search="{{ s.sale_date }} {{ s.employee.full_name }} {{ s.car }} {{ s.actual_sale_price }} {{ s.profit }}">
        <div class="cell date">
          <div class="lbl">Sale date</div>
          <div class="val">{{ s.sale_date }}</div>
        </div>

        <div class="cell employee">
          <div class="lbl">Employee</div>
          <div class="val">{{ s.employee.full_name }}</div>
        </div>

        <div class="cell car">
          <div class="lbl">Car</div>
          <div class="val">{{ s.car }}</div>
        </div>

        <div class="cell price">
          <div class="lbl">Actual price</div>
          <div class="val">{{ s.actual_sale_price }}</div>
        </div>

        <div class="cell profit">
          <div class="lbl">Profit</div>
          <div class="val" data-profit>{{ s.profit }}</div>
          <span class="tag mid" data-tag>Checkingâ€¦</span>
        </div>

        <div class="row-actions">
          <a class="a" href="{% url 'dealership:sale_edit' s.id %}">
            <span class="ic" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 20h9"></path>
                <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"></path>
              </svg>
            </span>
            Edit
          </a>

          <a class="a danger" href="{% url 'dealership:sale_delete' s.id %}">
            <span class="ic" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18"></path>
                <path d="M8 6V4h8v2"></path>
                <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
                <path d="M10 11v6"></path>
                <path d="M14 11v6"></path>
              </svg>
            </span>
            Delete
          </a>
        </div>
      </div>
    {% empty %}
      <div class="empty">No sales found. Click <strong>Add sale</strong> to create your first transaction.</div>
    {% endfor %}
  </div>

  <div class="empty" id="noMatch" style="display:none; margin-top: 12px;">
    No results match your search.
  </div>
</div>

<script>
(function(){
  const rows = Array.from(document.querySelectorAll('[data-row]'));
  const input = document.getElementById('saleSearch');
  const countEl = document.getElementById('saleCount');
  const noMatch = document.getElementById('noMatch');
  const hint = document.getElementById('searchHint');

  // Animate rows in
  const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  if(!prefersReduced){
    rows.forEach((r, i) => setTimeout(()=> r.classList.add('is-in'), 60 + i*70));
  } else {
    rows.forEach(r => r.classList.add('is-in'));
  }

  // Count badge
  countEl.textContent = `${rows.length} sales`;

  // Ctrl/Cmd+K focus search
  window.addEventListener('keydown', (e)=>{
    const isK = (e.key || '').toLowerCase() === 'k';
    if((e.ctrlKey || e.metaKey) && isK){
      e.preventDefault();
      input.focus();
      input.select();
    }
  });

  // Hide shortcut hint on touch devices
  try{
    if(window.matchMedia('(pointer: coarse)').matches){
      hint.style.display = 'none';
    }
  } catch(_){}

  // Profit tag
  function parseNumber(v){
    if(v == null) return 0;
    const s = String(v).replace(/[^0-9.,-]/g,'').replace(/,/g,'');
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : 0;
  }

  rows.forEach(r=>{
    const profitEl = r.querySelector('[data-profit]');
    const tagEl = r.querySelector('[data-tag]');
    const p = parseNumber(profitEl ? profitEl.textContent : 0);

    if(tagEl){
      tagEl.classList.remove('good','mid','bad');
      if(p > 0){
        tagEl.classList.add('good');
        tagEl.textContent = 'Positive';
      } else if (p === 0){
        tagEl.classList.add('mid');
        tagEl.textContent = 'Break-even';
      } else {
        tagEl.classList.add('bad');
        tagEl.textContent = 'Negative';
      }
    }
  });

  // Search filtering
  function applyFilter(){
    const q = (input.value || '').trim().toLowerCase();
    let visible = 0;

    rows.forEach(r=>{
      const hay = (r.getAttribute('data-search') || '').toLowerCase();
      const ok = !q || hay.includes(q);
      r.style.display = ok ? '' : 'none';
      if(ok) visible++;
    });

    countEl.textContent = `${visible} sales`;
    noMatch.style.display = (rows.length > 0 && visible === 0) ? '' : 'none';
  }

  input && input.addEventListener('input', applyFilter);
})();
</script>

{% endblock %}
