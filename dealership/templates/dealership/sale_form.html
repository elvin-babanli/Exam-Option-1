{% extends "base.html" %}
{% block content %}

<style>
  :root{
    --text:#0f172a;
    --muted:#475569;
    --border:rgba(15,23,42,.10);

    --primary:#2f6fed;
    --primary-2:#1d4ed8;
    --accent:#7c3aed;

    --danger:#ef4444;
    --success:#10b981;

    --shadow:0 18px 50px rgba(2,6,23,.12);
    --shadow-soft:0 12px 30px rgba(2,6,23,.08);

    --radius-xl:26px;
    --radius-lg:18px;
    --radius-md:14px;

    --ease:cubic-bezier(.2,.8,.2,1);
  }

  .form-page{
    display:grid;
    grid-template-columns: 1.1fr .9fr;
    gap: 14px;
    align-items:start;
  }
  @media (max-width: 980px){
    .form-page{ grid-template-columns: 1fr; }
  }

  .panel{
    background: rgba(255,255,255,.88);
    border: 1px solid var(--border);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow);
    overflow:hidden;
    transform: translateY(10px);
    opacity: 0;
    transition: transform .9s var(--ease), opacity .9s var(--ease);
  }
  .panel.is-in{ transform:none; opacity:1; }

  .panel-head{
    padding: 18px 18px 14px;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap: 12px;
    border-bottom: 1px solid rgba(15,23,42,.08);
    background:
      radial-gradient(600px 220px at 10% 0%, rgba(47,111,237,.14), transparent 60%),
      radial-gradient(520px 220px at 100% 0%, rgba(124,58,237,.12), transparent 60%),
      rgba(255,255,255,.75);
    backdrop-filter: blur(10px);
  }

  .title{
    margin:0;
    font-size: 20px;
    letter-spacing:-.02em;
    color: var(--text);
    font-weight: 1000;
  }
  .subtitle{
    margin: 6px 0 0;
    color: var(--muted);
    font-weight: 700;
    font-size: 13.5px;
    line-height: 1.5;
    max-width: 70ch;
  }

  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding: 8px 10px;
    border-radius: 999px;
    background: rgba(47,111,237,.10);
    border: 1px solid rgba(47,111,237,.18);
    color: #1e3a8a;
    font-weight: 900;
    font-size: 12px;
    white-space: nowrap;
  }

  .panel-body{ padding: 18px; }

  /* Django form */
  form p{ margin: 0 0 12px; }
  label{
    display:block;
    margin: 0 0 6px;
    color: var(--text);
    font-weight: 900;
    font-size: 13px;
  }

  input, select, textarea{
    width:100%;
    border-radius: 14px;
    border: 1px solid var(--border);
    padding: 12px;
    background: rgba(255,255,255,.92);
    color: var(--text);
    font-weight: 800;
    font-size: 14px;
    outline:none;
    transition: box-shadow .25s var(--ease), border-color .25s var(--ease), transform .25s var(--ease);
  }
  input:focus, select:focus, textarea:focus{
    border-color: rgba(47,111,237,.35);
    box-shadow: 0 0 0 6px rgba(47,111,237,.10);
    transform: translateY(-1px);
  }

  .errorlist{
    list-style:none;
    padding: 10px 12px;
    margin: 8px 0 12px;
    border-radius: 14px;
    background: rgba(239,68,68,.10);
    border: 1px solid rgba(239,68,68,.18);
    color:#7f1d1d;
    font-weight: 900;
    font-size: 13px;
  }
  .helptext{
    display:block;
    margin-top: 6px;
    color: var(--muted);
    font-weight: 700;
    font-size: 12.5px;
  }

  .actions{
    display:flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 14px;
    padding-top: 14px;
    border-top: 1px solid rgba(15,23,42,.08);
  }

  .btn{
    display:inline-flex;
    align-items:center;
    gap:10px;
    padding: 11px 14px;
    border-radius: 14px;
    border:1px solid var(--border);
    background: rgba(255,255,255,.92);
    color: var(--text);
    font-weight: 900;
    text-decoration:none;
    box-shadow: 0 12px 26px rgba(2,6,23,.08);
    transition: transform .25s var(--ease), box-shadow .25s var(--ease), border-color .25s var(--ease);
    cursor:pointer;
    user-select:none;
  }
  .btn:hover{
    transform: translateY(-2px);
    box-shadow: 0 18px 40px rgba(2,6,23,.12);
    border-color: rgba(47,111,237,.25);
  }
  .btn:active{ transform: translateY(0) scale(.99); }

  .btn.primary{
    background: linear-gradient(180deg, var(--primary), var(--primary-2));
    border-color: rgba(255,255,255,.35);
    color:#fff;
  }
  .btn .ic{ width:18px;height:18px; display:inline-flex; align-items:center; justify-content:center; }

  /* side */
  .side{
    background: rgba(255,255,255,.86);
    border: 1px solid var(--border);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-soft);
    padding: 18px;
    transform: translateY(12px);
    opacity: 0;
    transition: transform 1s var(--ease), opacity 1s var(--ease);
    transition-delay:.06s;
  }
  .side.is-in{ transform:none; opacity:1; }

  .side h3{
    margin: 0 0 10px;
    font-size: 15px;
    font-weight: 1000;
    color: var(--text);
  }

  .kpis{
    display:grid;
    grid-template-columns: repeat(2, minmax(0,1fr));
    gap: 10px;
    margin: 10px 0 12px;
  }
  .kpi{
    border-radius: 16px;
    padding: 12px;
    background: rgba(255,255,255,.90);
    border: 1px solid rgba(15,23,42,.08);
    box-shadow: 0 10px 22px rgba(2,6,23,.06);
  }
  .kpi .lbl{
    font-size: 12px;
    color: var(--muted);
    font-weight: 900;
  }
  .kpi .val{
    margin-top: 6px;
    font-size: 18px;
    font-weight: 1000;
    letter-spacing:-.02em;
    color: var(--text);
  }

  .tag{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding: 7px 10px;
    border-radius: 999px;
    font-weight: 1000;
    font-size: 12px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,.92);
  }
  .tag.good{
    background: rgba(16,185,129,.10);
    border-color: rgba(16,185,129,.18);
    color: #065f46;
  }
  .tag.bad{
    background: rgba(239,68,68,.10);
    border-color: rgba(239,68,68,.18);
    color: #7f1d1d;
  }
  .tag.mid{
    background: rgba(47,111,237,.10);
    border-color: rgba(47,111,237,.18);
    color: #1e3a8a;
  }

  .tips{
    list-style:none;
    margin:0;
    padding:0;
    display:grid;
    gap:10px;
  }
  .tip{
    border-radius: 16px;
    padding: 12px;
    background: rgba(255,255,255,.9);
    border: 1px solid rgba(15,23,42,.08);
    box-shadow: 0 10px 22px rgba(2,6,23,.06);
    color: var(--muted);
    font-weight: 800;
    line-height: 1.5;
  }
  .tip strong{ color: var(--text); }

  @media (prefers-reduced-motion: reduce){
    .panel,.side{ transition:none!important; transform:none!important; opacity:1!important; }
    input:focus, select:focus{ transform:none!important; }
  }
</style>

<div class="form-page">
  <!-- FORM -->
  <section class="panel" id="formPanel">
    <div class="panel-head">
      <div>
        <h2 class="title">Sale form</h2>
        <p class="subtitle">
          Register a sale transaction by selecting an employee, car, sale date and actual sale price.
        </p>
      </div>
      <span class="pill" id="modePill">
        <span aria-hidden="true">üìù</span> Editing
      </span>
    </div>

    <div class="panel-body">
      <form method="post" id="saleForm" novalidate>
        {% csrf_token %}
        {{ form.as_p }}

        <div class="actions">
          <button type="submit" class="btn primary">
            <span class="ic" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2Z"/>
                <path d="M17 21v-8H7v8"/>
                <path d="M7 3v5h8"/>
              </svg>
            </span>
            Save
          </button>

          <a class="btn" href="{% url 'dealership:sale_list' %}">
            <span class="ic" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18l-6-6 6-6"/>
              </svg>
            </span>
            Back to list
          </a>
        </div>
      </form>
    </div>
  </section>

  <!-- SIDE -->
  <aside class="side" id="sidePanel">
    <h3>Profit preview</h3>

    <div class="kpis">
      <div class="kpi">
        <div class="lbl">Selected car price</div>
        <div class="val" id="carPotential">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="lbl">Actual sale price</div>
        <div class="val" id="actualPrice">‚Äî</div>
      </div>
    </div>

    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 12px;">
      <div>
        <div class="lbl" style="margin-bottom:6px;">Estimated profit</div>
        <div class="val" id="profitVal" style="font-size: 20px; font-weight:1000;">‚Äî</div>
      </div>
      <span class="tag mid" id="profitTag">Waiting‚Ä¶</span>
    </div>

    <ul class="tips">
      <li class="tip"><strong>Employee</strong> should be the person who completed the sale.</li>
      <li class="tip"><strong>Car</strong> should match the vehicle sold (inventory item).</li>
      <li class="tip"><strong>Actual sale price</strong> is used in reports and profit calculation.</li>
      <li class="tip">If profit preview is not available, it means car option text doesn‚Äôt include price ‚Äî your backend reports still work normally.</li>
    </ul>
  </aside>
</div>

<script>
(function(){
  const formPanel = document.getElementById('formPanel');
  const sidePanel = document.getElementById('sidePanel');
  const modePill = document.getElementById('modePill');

  requestAnimationFrame(()=>{
    formPanel.classList.add('is-in');
    sidePanel.classList.add('is-in');
  });

  // Detect add vs edit (best-effort)
  const inputs = Array.from(document.querySelectorAll('#saleForm input, #saleForm select, #saleForm textarea'))
    .filter(el => el.type !== 'hidden' && el.name !== 'csrfmiddlewaretoken');

  const hasValue = inputs.some(el => (el.value || '').trim().length > 0);
  modePill.innerHTML = hasValue
    ? '<span aria-hidden="true">üìù</span> Editing'
    : '<span aria-hidden="true">‚ûï</span> Adding';

  // --- Profit preview (UI-only, safe fallback) ---
  // We try to parse a price number from the selected car option text.
  // If the option text doesn't contain any number, we show "‚Äî".
  const carSelect = document.querySelector('#saleForm select[name*="car"]') || document.querySelector('#saleForm select');
  const actualInput =
    document.querySelector('#saleForm input[name*="actual"]') ||
    document.querySelector('#saleForm input[type="number"]') ||
    document.querySelector('#saleForm input');

  const carPotentialEl = document.getElementById('carPotential');
  const actualEl = document.getElementById('actualPrice');
  const profitEl = document.getElementById('profitVal');
  const tagEl = document.getElementById('profitTag');

  function parseNumber(v){
    if(v == null) return null;
    const s = String(v).replace(/[^0-9.,-]/g,'').replace(/,/g,'');
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : null;
  }
  function formatNumber(n){
    if(n == null) return '‚Äî';
    try{ return n.toLocaleString(undefined, { maximumFractionDigits: 2 }); }
    catch(_){ return String(Math.round(n*100)/100); }
  }

  function getCarPotential(){
    if(!carSelect) return null;
    const opt = carSelect.options && carSelect.selectedIndex >= 0 ? carSelect.options[carSelect.selectedIndex] : null;
    if(!opt) return null;

    // try parse any number from option text, like: "BMW X5 (2020) - 45000"
    const n = parseNumber(opt.textContent || opt.innerText || '');
    return n;
  }

  function getActual(){
    if(!actualInput) return null;
    return parseNumber(actualInput.value);
  }

  function updatePreview(){
    const pot = getCarPotential();
    const act = getActual();

    carPotentialEl.textContent = formatNumber(pot);
    actualEl.textContent = formatNumber(act);

    if(pot == null || act == null){
      profitEl.textContent = '‚Äî';
      tagEl.className = 'tag mid';
      tagEl.textContent = 'Waiting‚Ä¶';
      return;
    }

    const profit = act - pot; // UI estimate (actual - potential)
    profitEl.textContent = formatNumber(profit);

    tagEl.classList.remove('good','mid','bad');
    if(profit > 0){
      tagEl.classList.add('good');
      tagEl.textContent = 'Above target';
    } else if (profit === 0){
      tagEl.classList.add('mid');
      tagEl.textContent = 'On target';
    } else {
      tagEl.classList.add('bad');
      tagEl.textContent = 'Below target';
    }
  }

  if(carSelect) carSelect.addEventListener('change', updatePreview);
  if(actualInput) actualInput.addEventListener('input', updatePreview);

  updatePreview();
})();
</script>

{% endblock %}
